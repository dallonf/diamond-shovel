var Resource = require('deployd/lib/resource')
  , util = require('util')
  , fs = require('fs')
  , less = require('less')
  , LessParser = less.Parser
  , path = require('path');

function Assets(name, options) {
  Resource.apply(this, arguments);  
  this.lessDir = this.config.lessDir || './less';
}

util.inherits(Assets, Resource);
module.exports = Assets;

var isBinary = {
    '.jpg': true
  , '.jpeg': true
  , '.gif': true
  , '.png': true
};

Assets.prototype.handle = function (ctx, next) {
  var ext = path.extname(ctx.url)
    , file = this.lessDir + ctx.url
    , assets = this;
    

  fs.exists(file, function (exists) {
    if(exists) {
      if(isBinary[ext]) {
        fs.createReadStream(file).pipe(ctx.res);
      } else {
        fs.readFile(file, 'utf-8', assets.render(ext, ctx));
      }
    } else {
      next();
    }
  });
};

Assets.prototype.render = function (ext, ctx) {
  var assets = this;
  
  return function (err, data) {
    if (ext === '.less') {
      var lessPath = path.join(assets.lessDir, path.dirname(ctx.url)).replace('\\', '/');
      var parser = new LessParser({paths: [lessPath]});
      parser.parse(data, function (err, tree) {
        var result;
        if(err) return ctx.done(err);
        try {
          result = tree.toCSS();  
          assets.setHeaders(ext, result, ctx);
          ctx.res.end(result);
        } catch (ex) {
          ctx.done(ex);
        }
        
      });
    } else {
      assets.setHeaders(ext, data, ctx);
      ctx.res.end(data);
    }
  };
};

var mime = {
    '.less': 'text/css'
  , '.js':   'application/javascript'
};

Assets.prototype.setHeaders = function (ext, data, ctx) {
  ctx.res.setHeader('Content-Type', mime[ext] || 'text/plain');
  ctx.res.setHeader('Content-Length', data.length);
};